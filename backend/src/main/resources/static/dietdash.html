<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diet Page - Vision Fit</title>
  <link href="https://fonts.googleapis.com/css2?family=Inknut+Antiqua:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inknut Antiqua', sans-serif;
      background-color: #1f2b5a;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      position: relative;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2473ff;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
      height: 113px;
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: white;
    }
    .logo span {
      color: lightblue;
    }
    nav ul li a.logout {
      text-decoration: none;
      color: white;
      background-color: #ff5b5b;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
    }
    nav ul li {
      display: inline;
    }
    nav ul li a {
      text-decoration: none;
      color: white;
      font-weight: bold;
    }
    .content {
      display: flex;
      justify-content: space-between;
      width: 90%;
      margin-top: 20px;
      gap: 20px;
    }
    .modal, .search-container, .macro-tracker {
      width: 33%;
      padding: 20px;
      background: #f4f4f4;
      border-radius: 10px;
      height: fit-content;
    }
    .input-group {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .input-group label {
      flex: 1;
    }
    .input-group input, .input-group select {
      height: 25px;
      padding: 5px;
    }
    .search-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .search-box-wrapper {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #combined-search-bar {
      width: 100%;
      padding: 15px;
      font-size: 20px;
      background-color: #f4f4f4;
      margin: 20px 0 10px;
      border-radius: 8px;
      border: 2px solid #2473ff;
      box-sizing: border-box;
    }
    .food-result {
      background: #fff;
      border-radius: 5px;
      width: 100%;
      box-sizing: border-box;
      padding: 15px;
      margin-bottom: 10px;
    }
    .food-result em {
      display: block;
      margin-top: 10px;
    }
    .food-result .nutrition, .food-result .analysis {
      margin-bottom: 15px;
    }
    .modal h2, .macro-tracker h2 {
      margin-bottom: 30px;
    }
    h3 { 
      color: black;
      text-align: center;
      margin-bottom: 10px;
    }
    p { color: #f4f4f4; }
    #combined-results {
      width: 100%;
      max-height: 400px;
      overflow-y: auto;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .submit-btn, .add-macros-btn {
      margin-top: 10px;
      padding: 8px 15px;
      background-color: #2473ff;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    #metric, #goal {
      height: 38px;
      padding: 5px;
    }
    .macro-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .macro-table th, .macro-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .macro-table th {
      background-color: #2473ff;
      color: white;
    }
    .macro-table tr:nth-child(even) {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">VISION<span>FIT</span></div>
    <nav>
      <ul>
        <li><a href="">Diet Dash</a></li>
        <li><a href="trainerdash.html">Trainer Dash</a></li>
        <li><a href="Mission_Team.html">Our Mission</a></li>
        <li><a href="athlete_dashboard.html">Athlete Dash</a></li>
        <li><a href="index.html" class="logout">LOGOUT</a></li>
      </ul>
    </nav>
  </header>

  <div class="content">
    <div class="modal">
      <h2>User Info</h2>
      <div class="input-group">
        <label for="weight">Current Weight:</label>
        <input type="number" id="weight" style="width: 180px;">
        <select id="metric" style="width: 50px;">
          <option value="lb">lb</option>
          <option value="kg">kg</option>
        </select>
      </div>
      <div class="input-group">
        <label for="height-feet">Height:</label>
        <div style="display: flex; gap: 10px;">
          <input type="number" id="height-feet" placeholder="ft" style="width: 103px;">
          <input type="number" id="height-inches" placeholder="in" style="width: 103px;">
        </div>
      </div>      
      <div class="input-group">
        <label for="goal">Goal:</label>
        <select id="goal">
          <option value="" disabled selected>Select a goal</option>
          <option value="lose">Lose Weight</option>
          <option value="gain">Gain Weight</option>
          <option value="maintain">Maintain Weight</option>
          <option value="build">Build Muscle</option>
          <option value="lean">Get Leaner</option>
        </select>
      </div>
      <button class="submit-btn" onclick="submitGoal()">Submit</button>
    </div>

    <div class="search-container">
      <h3>Get Nutrition Information</h3>
      <div class="search-box-wrapper">
        <input type="text" id="combined-search-bar" placeholder="Search for food nutrition...">
        <div id="combined-results"></div>
      </div>
    </div>

    <div class="macro-tracker">
      <h2>Macro Tracker</h2>
      <table class="macro-table">
        <thead>
          <tr>
            <th>Nutrient</th>
            <th>Consumed</th>
            <th>Daily Goal</th>
            <th>% Completed</th>
          </tr>
        </thead>
        <tbody id="macro-table-body">
          <tr>
            <td>Calories (kcal)</td>
            <td id="calories-consumed">0</td>
            <td id="calories-goal">2000</td>
            <td id="calories-percent">0%</td>
          </tr>
          <tr>
            <td>Protein (g)</td>
            <td id="protein-consumed">0</td>
            <td id="protein-goal">50</td>
            <td id="protein-percent">0%</td>
          </tr>
          <tr>
            <td>Carbs (g)</td>
            <td id="carbs-consumed">0</td>
            <td id="carbs-goal">275</td>
            <td id="carbs-percent">0%</td>
          </tr>
          <tr>
            <td>Fat (g)</td>
            <td id="fat-consumed">0</td>
            <td id="fat-goal">70</td>
            <td id="fat-percent">0%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const CALORIE_NINJAS_API_KEY = "rYzH1pB46F9BsHel1beq4w==2dMCoBMLix22FUBM";
    const GEMINI_API_KEY = "AIzaSyChBpvxw6IeA8PgfIgHzR-6573XmHf3rmk";

    let macroTotals = {
      calories: 0,
      protein: 0,
      carbs: 0,
      fat: 0
    };

    const dailyGoals = {
      calories: 2000,
      protein: 50,
      carbs: 275,
      fat: 70
    };

    async function searchCombined(event) {
      if (event.key !== 'Enter') return;
      const query = document.getElementById("combined-search-bar").value.trim();
      if (!query) return;

      document.getElementById("combined-results").innerHTML = "<p>Loading...</p>";
      try {
        const [calorieData, geminiResult] = await Promise.all([
          fetchCalorieData(query),
          analyzeFoodWithGemini(query, document.getElementById("goal").value || "unspecified")
        ]);
        displayCombinedResults(calorieData, [geminiResult]);
      } catch (error) {
        console.error("Error in combined search:", error);
        document.getElementById("combined-results").innerHTML = "<p>Failed to fetch data.</p>";
      }
      document.getElementById("combined-search-bar").value = "";
    }

    async function fetchCalorieData(query) {
      const url = `https://api.calorieninjas.com/v1/nutrition?query=${encodeURIComponent(query)}`;
      const response = await fetch(url, {
        method: "GET",
        headers: { "X-Api-Key": CALORIE_NINJAS_API_KEY, "Content-Type": "application/json" }
      });
      if (!response.ok) throw new Error(`CalorieNinjas API request failed: ${response.statusText}`);
      return await response.json();
    }

    async function analyzeFoodWithGemini(foodName, goal) {
      const goalText = goal !== "unspecified" ? goal.replace(/lose|gain|maintain|build|lean/, 
        match => ({
          lose: "losing weight",
          gain: "gaining weight",
          maintain: "maintaining weight",
          build: "building muscle",
          lean: "getting leaner"
        }[match])) : "an unspecified fitness goal";

      const prompt = `Provide the following about ${foodName}:
      1. A short sentence describing its main nutritional benefit.
      2. A sentence evaluating its suitability for ${goalText}.
      3. A simple recipe that includes ${foodName} with basic ingredients and steps.`;

      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        });
        if (!response.ok) throw new Error(`Gemini API request failed: ${response.statusText}`);
        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text;
        const lines = text.split('\n').filter(line => line.trim());
        return {
          foodName,
          benefit: lines[0] || "No benefit found.",
          suitability: lines[1] || "No suitability analysis.",
          recipe: lines.slice(2).join('<br>') || "No recipe provided."
        };
      } catch (error) {
        console.error(`Error analyzing ${foodName} with Gemini:`, error);
        return {
          foodName,
          benefit: "Unable to analyze nutritional benefits.",
          suitability: `Unable to evaluate suitability for ${goalText}.`,
          recipe: "No recipe found."
        };
      }
    }

    function addMacrosToTracker(item) {
      macroTotals.calories += parseFloat(item.calories) || 0;
      macroTotals.protein += parseFloat(item.protein_g) || 0;
      macroTotals.carbs += parseFloat(item.carbohydrates_total_g) || 0;
      macroTotals.fat += parseFloat(item.fat_total_g) || 0;

      updateMacroTable();
    }

    function updateMacroTable() {
      document.getElementById("calories-consumed").textContent = macroTotals.calories.toFixed(1);
      document.getElementById("protein-consumed").textContent = macroTotals.protein.toFixed(1);
      document.getElementById("carbs-consumed").textContent = macroTotals.carbs.toFixed(1);
      document.getElementById("fat-consumed").textContent = macroTotals.fat.toFixed(1);

      document.getElementById("calories-percent").textContent = ((macroTotals.calories / dailyGoals.calories) * 100).toFixed(1) + "%";
      document.getElementById("protein-percent").textContent = ((macroTotals.protein / dailyGoals.protein) * 100).toFixed(1) + "%";
      document.getElementById("carbs-percent").textContent = ((macroTotals.carbs / dailyGoals.carbs) * 100).toFixed(1) + "%";
      document.getElementById("fat-percent").textContent = ((macroTotals.fat / dailyGoals.fat) * 100).toFixed(1) + "%";
    }

    function displayCombinedResults(calorieData, geminiResults) {
      const resultsDiv = document.getElementById("combined-results");
      resultsDiv.innerHTML = "";

      if (calorieData.items && calorieData.items.length > 0) {
        calorieData.items.forEach((item, index) => {
          const geminiResult = geminiResults[index] || {
            foodName: item.name,
            benefit: "No analysis available.",
            suitability: "No suitability analysis.",
            recipe: "No recipe provided."
          };

          const div = document.createElement("div");
          div.classList.add("food-result");
          div.innerHTML = `
            <strong>${item.name}</strong>
            <div class="nutrition">
              <strong>Nutritional Breakdown:</strong><br>
              Calories: ${item.calories} kcal<br>
              Protein: ${item.protein_g} g<br>
              Carbs: ${item.carbohydrates_total_g} g<br>
              Fat: ${item.fat_total_g} g
            </div>
            <div class="analysis">
              <em><strong>Nutritional Benefit:</strong> ${geminiResult.benefit}</em><br>
              <em><strong>Suitability:</strong> ${geminiResult.suitability}</em><br>
              <em><strong>Recipe:</strong><br>${geminiResult.recipe}</em>
            </div>
            <button class="add-macros-btn" onclick='addMacrosToTracker(${JSON.stringify(item)})'>Add to Tracker</button>
          `;
          resultsDiv.appendChild(div);
        });
      } else {
        resultsDiv.innerHTML = "<p>No food items found.</p>";
      }
    }

    function submitGoal() {
      const goalInput = document.getElementById("goal");
      const goal = goalInput.value.trim();
      if (!goal) {
        alert("Please enter a fitness goal before proceeding.");
        return;
      }
      document.querySelector('.search-container').style.display = 'block';
    }

    document.getElementById("combined-search-bar").addEventListener("keyup", searchCombined);
  </script>
</body>
</html>