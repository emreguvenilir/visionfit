<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diet Page - Vision Fit</title>
  <link href="https://fonts.googleapis.com/css2?family=Inknut+Antiqua:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inknut Antiqua', sans-serif;
      background-color: #1f2b5a;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      position: relative;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2473ff;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
      height: 113px;
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: white;
    }
    .logo span {
      color: lightblue;
    }
    nav ul li a.logout {
      text-decoration: none;
      color: white;
      background-color: #ff5b5b;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
    }
    nav ul li {
      display: inline;
    }
    nav ul li a {
      text-decoration: none;
      color: white;
      font-weight: bold;
    }
    .content {
      display: flex;
      justify-content: space-between;
      width: 90%;
      margin-top: 20px;
    }
    .modal {
      width: 45%;
      padding: 20px;
      background: #f4f4f4;
      border-radius: 10px;
      height: fit-content;
    }
    .input-group {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .input-group label {
      flex: 1;
    }
    .input-group input, .input-group select {
      height: 25px;
      padding: 5px;
    }
    .search-container {
      width: 50%;
      display: flex;
      flex-direction: column;
    }
    #search-bar, #recipe-bar, #gemini-bar {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      background-color: #f4f4f4;
      margin-bottom: 10px;
    }
    .food-result {
      margin-top: 15px;
      padding: 10px;
      background: #f4f4f4;
      border-radius: 3px;
    }
    .food-result em {
      display: block;
      margin-top: 5px;
    }
    .modal h2 {
      margin-bottom: 30px;
    }
    h3 { color: white; }
    p { color: #f4f4f4; }
    .gemini-container {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 300px;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
    }
    .gemini-container h3 {
      margin-top: 0;
    }
    #gemini-results {
      max-height: 150px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">VISION<span>FIT</span></div>
    <nav>
      <ul>
        <li><a href="">Diet Dash</a></li>
        <li><a href="trainerdash.html">Trainer Dash</a></li>
        <li><a href="Mission_Team.html">Our Mission</a></li>
        <li><a href="athlete_dashboard.html">Athlete Dash</a></li>
        <li><a href="index.html" class="logout">LOGOUT</a></li>
      </ul>
    </nav>
  </header>

  <div class="content">
    <div class="modal">
      <h2>User Info</h2>
      <div class="input-group">
        <label for="username">Username:</label>
        <input type="text" id="username" style="width: 230px;">
      </div>
      <div class="input-group">
        <label for="weight">Current Weight:</label>
        <input type="number" id="weight" style="width: 180px;">
        <select id="metric" style="width: 50px;">
          <option value="lb">lb</option>
          <option value="kg">kg</option>
        </select>
      </div>
      <div class="input-group">
        <label for="height">Height (feet):</label>
        <input type="number" id="height" style="width: 230px;">
      </div>
      <div class="input-group">
        <label for="goal">Goal:</label>
        <select id="goal">
          <option value="" disabled selected>Select a goal</option>
          <option value="lose">Lose Weight</option>
          <option value="gain">Gain Weight</option>
          <option value="maintain">Maintain Weight</option>
          <option value="build">Build Muscle</option>
          <option value="lean">Get Leaner</option>
        </select>
      </div>
    </div>

    <div class="search-container">
      <h3>Search Food Item Below:</h3>
      <input type="text" id="search-bar" placeholder="Search for food..." onkeyup="searchFood(event)">
      <div id="results"></div>

      <h3 style="margin-top: 40px;">Search Food Recipe Below:</h3>
      <input type="text" id="recipe-bar" placeholder="Search for recipe..." onkeyup="searchRecipe(event)">
      <div id="recipe-results"></div>
    </div>
  </div>

  <div class="gemini-container">
    <h3>Analyze Food Benefits:</h3>
    <input type="text" id="gemini-bar" placeholder="Enter food (select goal above)..." onkeyup="searchGemini(event)">
    <div id="gemini-results"></div>
  </div>

  <script>
    const CALORIE_NINJAS_API_KEY = "rYzH1pB46F9BsHel1beq4w==2dMCoBMLix22FUBM";
    const GEMINI_API_KEY = "AIzaSyChBpvxw6IeA8PgfIgHzR-6573XmHf3rmk";

    async function searchFood(event) {
      if (event.key !== 'Enter') return;
      const query = document.getElementById("search-bar").value.trim();
      if (!query) return;

      const url = `https://api.calorieninjas.com/v1/nutrition?query=${encodeURIComponent(query)}`;
      try {
        const response = await fetch(url, {
          method: "GET",
          headers: { "X-Api-Key": CALORIE_NINJAS_API_KEY, "Content-Type": "application/json" }
        });
        if (!response.ok) throw new Error(`CalorieNinjas API request failed: ${response.statusText}`);
        const data = await response.json();
        displayFoodResults(data);
      } catch (error) {
        console.error("Error fetching food data:", error);
        document.getElementById("results").innerHTML = "<p>Failed to fetch food data.</p>";
      }
    }

    function displayFoodResults(data) {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";
      if (data.items && data.items.length > 0) {
        data.items.forEach(item => {
          const div = document.createElement("div");
          div.classList.add("food-result");
          div.innerHTML = `<strong>${item.name}</strong><br>
            Calories: ${item.calories} kcal<br>
            Protein: ${item.protein_g} g<br>
            Carbs: ${item.carbohydrates_total_g} g<br>
            Fat: ${item.fat_total_g} g`;
          resultsDiv.appendChild(div);
        });
      } else {
        resultsDiv.innerHTML = "<p>No food items found.</p>";
      }
    }

    async function searchGemini(event) {
      if (event.key !== 'Enter') return;
      const query = document.getElementById("gemini-bar").value.trim();
      const goal = document.getElementById("goal").value || "unspecified";
      if (!query) return;

      try {
        const geminiResult = await analyzeFoodWithGemini(query, goal);
        displayGeminiResults([geminiResult]);
        document.getElementById("gemini-bar").value = ""; // Clear input
      } catch (error) {
        console.error("Error in Gemini search:", error);
        document.getElementById("gemini-results").innerHTML = "<p>Failed to analyze food.</p>";
      }
    }

    async function analyzeFoodWithGemini(foodName, goal) {
      const goalText = goal !== "unspecified" ? goal.replace(/lose|gain|maintain|build|lean/, 
        match => ({
          lose: "losing weight",
          gain: "gaining weight",
          maintain: "maintaining weight",
          build: "building muscle",
          lean: "getting leaner"
        }[match])) : "an unspecified fitness goal";
      const prompt = `Provide two short sentences about ${foodName}: 
        1. Describe its primary nutritional benefit or characteristic (e.g., "Chicken: Great source of protein"). 
        2. Evaluate its suitability for a user with the goal of ${goalText} (e.g., "Chicken is excellent for building muscle due to its high protein content").`;
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
      
      try {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        });
        if (!response.ok) {
          throw new Error(`Gemini API request failed with status ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
          throw new Error("Unexpected response structure from Gemini API");
        }
        const text = data.candidates[0].content.parts[0].text;
        const [benefit, suitability] = text.split('\n').filter(line => line.trim());
        return { 
          foodName, 
          benefit: benefit || "Unable to analyze nutritional benefits.", 
          suitability: suitability || `Unable to evaluate suitability for ${goalText}.`
        };
      } catch (error) {
        console.error(`Error analyzing ${foodName} with Gemini:`, error.message);
        return { 
          foodName, 
          benefit: "Unable to analyze nutritional benefits.", 
          suitability: `Unable to evaluate suitability for ${goalText}.`
        };
      }
    }

    function displayGeminiResults(geminiResults) {
      const resultsDiv = document.getElementById("gemini-results");
      resultsDiv.innerHTML = "";
      geminiResults.forEach(result => {
        const div = document.createElement("div");
        div.classList.add("food-result");
        div.innerHTML = `<strong>${result.foodName}</strong><br>
          <em>${result.benefit}</em><br>
          <em>${result.suitability}</em>`;
        resultsDiv.appendChild(div);
      });
    }

    async function searchRecipe(event) {
      if (event.key !== 'Enter') return;
      const query = document.getElementById("recipe-bar").value.trim();
      if (!query) return;

      const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
      const apiUrl = `https://api.calorieninjas.com/v1/recipe?query=${encodeURIComponent(query)}`;
      const fullUrl = proxyUrl + apiUrl;

      try {
        const response = await fetch(fullUrl, {
          method: 'GET',
          headers: { 'X-Api-Key': CALORIE_NINJAS_API_KEY }
        });
        if (!response.ok) throw new Error(`Recipe API request failed: ${response.statusText}`);
        const data = await response.json();
        displayRecipeResults(data);
      } catch (error) {
        console.error("Error fetching recipe data:", error);
        document.getElementById("recipe-results").innerHTML = "<p>Failed to fetch recipe data.</p>";
      }
    }

    function displayRecipeResults(data) {
      const recipeResultDiv = document.getElementById("recipe-results");
      recipeResultDiv.innerHTML = "";
      if (data && data.length > 0) {
        data.forEach(recipe => {
          const div = document.createElement("div");
          div.classList.add("food-result");
          div.innerHTML = `<strong>${recipe.title}</strong><br>
            Ingredients: ${recipe.ingredients}<br>
            Servings: ${recipe.servings}<br>
            Instructions: ${recipe.instructions || 'Not available'}`;
          recipeResultDiv.appendChild(div);
        });
      } else {
        recipeResultDiv.innerHTML = "<p>No recipes found.</p>";
      }
    }
  </script>
</body>
</html>